#!/usr/bin/env bash
# Sample not used directly
set -euo pipefail

# default values (can be overridden by env)
: "${NODE_ID:=1}"
: "${PROCESS_ROLES:=broker,controller}"   # can be "broker" or "controller,broker"
: "${BROKER_ID:=${NODE_ID}}"
: "${KRAFT_CONTROLLER_LISTENER:=CONTROLLER://0.0.0.0:9093}"
: "${PLAINTEXT_LISTENER:=PLAINTEXT://0.0.0.0:9092}"
: "${ADVERTISED_LISTENERS:=PLAINTEXT://localhost:9092}"
: "${CONTROLLER_QUORUM_VOTERS:=1@controller1:9093,2@controller2:9093,3@controller3:9093}"
: "${LOG_DIR:=/var/lib/kafka/data}"
: "${METADATA_LOG_DIR:=/var/lib/kafka/data/__kraft_meta}"

# create data dirs
mkdir -p "${LOG_DIR}" "${METADATA_LOG_DIR}" /var/log/kafka

# Create server.properties from template by simple env substitution
TEMPLATE=/opt/scripts/server.properties.template
CONFIG=/opt/config/server.properties
mkdir -p /opt/config

envsubst < "${TEMPLATE}" > "${CONFIG}"

echo "==== Start kafka with config ===="
cat "${CONFIG}"
echo "================================="

# Start Kafka server (KRaft capable) - uses server.properties
exec /opt/bin/kafka-server-start.sh "${CONFIG}"

